<html lang="it">

<head>
    <title>client</title>
    <link rel="icon" href="./images/favicon.png" type="image/x-icon" />
    <link rel="shortcut icon" href="./images/favicon.png" type="image/x-icon" />
    <meta name="theme-color" content="black">
    <meta name="msapplication-navbutton-color" content="black">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <style type="text/css">
        body {
            padding:0;
            margin:0;
        }
        #cnt {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
                position: absolute;
        }
        .snake {
            background-color: red;
            position: absolute;
            border-radius: 100%;
            opacity: .5;
        }
        .ball {
            background-color: black;
            position: absolute;
            border-radius: 100%;
        }
        .wall {
            position: absolute;
            background-color: gray;
        }
        .wallTop {
            

        }
        #joy {
            position: absolute;
            left:0px;
            right:0px;
            margin:auto;
            bottom: 10px;
            width: 100px;
            height: 100px;
            border:1px solid black;
        }
        .pad {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 100%;
            background-color: red;
            pointer-events: none;
        }
    </style>
    <script type="text/javascript">
        var current = 'https://cleope.herokuapp.com';
        if (window.location.href.indexOf('localhost') != -1) {
            current = '//localhost:3000';
        }
        var socket = io.connect(current);
        var angle = 0;
        var speed = 2;
        $(function() {
            socket.emit('join');
            
            // $('#joy').on('mousemove',function(e){
            //     var a = {x:50,y:0}
            //     var b = {x:50,y:50}
            //     var c = {x:e.offsetX,y:e.offsetY}
            //     angle = 180 - ((find_angle(a,b,c) * 180) / Math.PI)
            //     if(e.offsetX<50) angle = - angle

            // })
            // $('#joy').on('mousedown',function(e){
            //     speed = 3
            // })
            // $('#joy').on('mouseup',function(e){
            //     speed = 2
            // })
            var joyActive = false;
            $('#joy').on('touchmove',function(e){
               
                //e = e.originalEvent.touches[0]
                
                 var rect = e.target.getBoundingClientRect();
                var x = e.targetTouches[0].pageX - rect.left;
                var y = e.targetTouches[0].pageY - rect.top;
                 console.log(x)
                if(joyActive) {
                    var a = {x:50,y:0}
                    var b = {x:50,y:50}
                    var c = {x:x,y:y}
                    angle = 180 - ((find_angle(a,b,c) * 180) / Math.PI)
                    if(x<50) angle = - angle
                    $('.pad').css('top',y-20)
                    $('.pad').css('left',x-20)
                }
            })
            $('#joy').on('touchstart',function(e){
                speed = 3
                joyActive = true;
            })
            $('#joy').on('touchend',function(e){
                speed = 2
                joyActive = false;
            })



            
            socket.on('message',displayMessage);
            function displayMessage(data){
                console.log(data)
            }
            socket.on('game',displayGame);
            function displayGame(data){
                var scale = 1;
                scale = 20/data.snakes[socket.id].dim
                var gapX = ((data.snakes[socket.id].x)-($(window).width()/2/scale))
                var gapY = ((data.snakes[socket.id].y)-$(window).height()/2/scale)
                for (var i in data.snakes) {
                    if($('#'+i).length==0)
                        $('#cnt').append('<div class="snake" id="'+i+'"></div>')
                    $('#'+i).css('width',data.snakes[i].dim*scale)
                    $('#'+i).css('height',data.snakes[i].dim*scale)
                    $('#'+i).css('left',(data.snakes[i].x-gapX-data.snakes[i].dim/2)*scale)
                    $('#'+i).css('top',(data.snakes[i].y-gapY-data.snakes[i].dim/2)*scale)
                    if(data.snakes[i].history) {
                       for (var j = 0; j < data.snakes[i].history.length; j++) {
                           var u = i+'his'+j;
                           $('#'+u).remove()
                           $('#cnt').append('<div class="snake" id="'+u+'"></div>')
                            $('#'+u).css('left',(data.snakes[i].history[j].x-gapX-data.snakes[i].dim/2)*scale)
                            $('#'+u).css('top',(data.snakes[i].history[j].y-gapY-data.snakes[i].dim/2)*scale)
                            $('#'+u).css('width',data.snakes[i].dim*scale)
                            $('#'+u).css('height',data.snakes[i].dim*scale)
                       }
                    }
                    if(data.snakes[i].dead)
                    $('#'+i).remove()

                }
                $('.ball').remove()
                for (var i in data.balls) {
                    
                    $('#cnt').append('<div class="ball" id="'+i+'"></div>')
                    $('#'+i).css('width',data.balls[i].dim*scale)
                    $('#'+i).css('height',data.balls[i].dim*scale)
                    $('#'+i).css('left',(data.balls[i].x-gapX-data.balls[i].dim/2)*scale)
                    $('#'+i).css('top',(data.balls[i].y-gapY-data.balls[i].dim/2)*scale)
                }
                if($('.wallTop').length==0)
                $('#cnt').append('<div class="wallTop wall"></div>')
                $('.wallTop').css('left',(0-gapX)*scale)
                $('.wallTop').css('top',(0-gapY-(2*scale))*scale)
                $('.wallTop').css('height',2*scale)
                $('.wallTop').css('width',1000*scale)
                if($('.wallBottom').length==0)
                $('#cnt').append('<div class="wallBottom wall"></div>')
                $('.wallBottom').css('left',(0-gapX)*scale)
                $('.wallBottom').css('top',(1000-gapY-(2*scale))*scale)
                $('.wallBottom').css('height',2*scale)
                $('.wallBottom').css('width',1000*scale)
                if($('.wallright').length==0)
                $('#cnt').append('<div class="wallright wall"></div>')
                $('.wallright').css('left',(0-gapX)*scale)
                $('.wallright').css('top',(0-gapY-(2*scale))*scale)
                $('.wallright').css('width',2*scale)
                $('.wallright').css('height',1000*scale)
                if($('.wallleft').length==0)
                $('#cnt').append('<div class="wallleft wall"></div>')
                $('.wallleft').css('left',(1000-gapX)*scale)
                $('.wallleft').css('top',(0-gapY-(2*scale))*scale)
                $('.wallleft').css('width',2*scale)
                $('.wallleft').css('height',1000*scale)

            }
            socket.on('start',startGame);
            function startGame(data){
                setInterval(function(){
                    console.log(angle)
                    socket.emit('getGame',{angle:angle,speed:speed}); 
                },50)
            }
            $(window).on('resize',function(){
                resizeLand();
            })
            function resizeLand() {
                
            }
            function find_angle(A,B,C) {
                var AB = Math.sqrt(Math.pow(B.x-A.x,2)+ Math.pow(B.y-A.y,2));    
                var BC = Math.sqrt(Math.pow(B.x-C.x,2)+ Math.pow(B.y-C.y,2)); 
                var AC = Math.sqrt(Math.pow(C.x-A.x,2)+ Math.pow(C.y-A.y,2));
                return Math.acos((BC*BC+AB*AB-AC*AC)/(2*BC*AB));
            }
            function uuid() {
              return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
              });
            }


        });
    </script>
</head>

<body>
    <div id="cnt"></div>
    <div id="joy">
        <div class="pad"></div>
    </div>
    <!-- <div class="status">
        <div class="s"></div>
    </div>
    <div class="landCont">
        
    </div>
    <div class="controls">
        <input type="button" class="us" value='upgrade s'></input>
    </div> -->
</body>

</html>